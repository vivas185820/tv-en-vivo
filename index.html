<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>TV en Vivo VT</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
*{box-sizing:border-box}
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial}
#header{position:fixed;top:0;left:0;right:0;height:44px;background:#111;display:flex;align-items:center;justify-content:center;z-index:1000}
#playerWrapper{position:fixed;top:44px;left:0;right:0;height:180px;background:#000;z-index:999}
#player{width:100%;height:100%;object-fit:contain}
#content{margin-top:235px;padding:10px}
.section-title{font-size:14px;margin:8px 0 4px}
select,input,button{width:100%;margin-bottom:6px;background:#1c1c1c;color:#fff;border:none;padding:6px;border-radius:5px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.channel{background:#1a1a1a;border-radius:6px;padding:6px;text-align:center}
.channel img{width:100%;height:60px;object-fit:contain}
.channel-name{font-size:12px;margin-top:4px}
.fav{font-size:18px}
#loader{text-align:center;margin:15px}
#settingsBox{display:none;background:#111;padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>

<body>

<div id="header">üì∫ TV en Vivo VT</div>

<div id="playerWrapper">
  <video id="player" controls playsinline></video>
</div>

<div id="content">

  <div class="section-title">‚≠ê Favoritos</div>
  <button onclick="showFavorites()">Ver solo favoritos</button>

  <div class="section-title">‚öôÔ∏è Ajustes IPTV</div>
  <button onclick="toggleSettings()">Cambiar lista IPTV</button>

  <div id="settingsBox">
    <input id="iptvInput" placeholder="Pega aqu√≠ tu URL M3U">
    <button onclick="saveIPTV()">Guardar y recargar</button>
  </div>

  <div class="section-title">üóÇ Categor√≠as</div>
  <select id="category"></select>

  <div class="section-title">üîç Buscar</div>
  <input id="search" placeholder="Buscar canal...">

  <div id="loader">‚è≥ Cargando canales...</div>
  <div class="grid" id="channelList"></div>

</div>

<script>
let IPTV_URL = localStorage.getItem("custom_iptv_url") ||
"https://raw.githubusercontent.com/iptv-org/iptv/master/languages/spa.m3u";

const CACHE_KEY="iptv_cache_fast";
const CACHE_TIME=1000*60*60*24;
const PAGE_SIZE=20;

let allChannels=[], visibleChannels=[], favorites=JSON.parse(localStorage.getItem("favorites_vt")||"[]"), page=0;

function toggleSettings(){
  const box=document.getElementById("settingsBox");
  box.style.display=box.style.display==="none"?"block":"none";
  document.getElementById("iptvInput").value=IPTV_URL;
}

function saveIPTV(){
  const url=document.getElementById("iptvInput").value.trim();
  if(!url.endsWith(".m3u")&&!url.endsWith(".m3u8")){alert("URL inv√°lida");return;}
  localStorage.setItem("custom_iptv_url",url);
  location.reload();
}

async function loadList(){
  try{
    const cached=JSON.parse(localStorage.getItem(CACHE_KEY)||"null");
    if(cached && (Date.now()-cached.time)<CACHE_TIME){
      allChannels=cached.data; initUI(); return;
    }
    const res=await fetch(IPTV_URL);
    const text=await res.text();
    allChannels=parseM3U(text);
    localStorage.setItem(CACHE_KEY,JSON.stringify({time:Date.now(),data:allChannels}));
    initUI();
  }catch(e){
    document.getElementById("loader").innerText="‚ùå Error cargando lista";
  }
}

function parseM3U(text){
  const lines=text.split("\n"), arr=[];
  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      const name=lines[i].split(",")[1]||"Canal";
      const logo=(lines[i].match(/tvg-logo="(.*?)"/)||[])[1]||"https://via.placeholder.com/150x80?text=TV";
      const group=(lines[i].match(/group-title="(.*?)"/)||[])[1]||"Otros";
      const url=lines[i+1];
      const id=btoa(name+url);
      arr.push({id,name,logo,group,url});
    }
  }
  return arr;
}

function initUI(){
  document.getElementById("loader").style.display="none";
  visibleChannels=allChannels;
  buildCategories();
  renderNext();
  play(0);
}

function buildCategories(){
  const cat=document.getElementById("category");
  const groups=["Todos",...new Set(allChannels.map(c=>c.group))];
  cat.innerHTML="";
  groups.forEach(g=>{
    const o=document.createElement("option");
    o.value=g;o.textContent=g;cat.appendChild(o);
  });
  cat.onchange=()=>{
    visibleChannels=cat.value==="Todos"?allChannels:allChannels.filter(c=>c.group===cat.value);
    resetRender();
  };
}

document.getElementById("search").oninput=e=>{
  const t=e.target.value.toLowerCase();
  visibleChannels=allChannels.filter(c=>c.name.toLowerCase().includes(t));
  resetRender();
};

function showFavorites(){
  visibleChannels=allChannels.filter(c=>favorites.includes(c.id));
  resetRender();
}

function resetRender(){
  page=0;
  document.getElementById("channelList").innerHTML="";
  renderNext();
}

function renderNext(){
  const start=page*PAGE_SIZE, end=start+PAGE_SIZE;
  const slice=visibleChannels.slice(start,end);
  const list=document.getElementById("channelList");
  const frag=document.createDocumentFragment();

  slice.forEach((ch,i)=>{
    const div=document.createElement("div");
    div.className="channel";
    div.innerHTML=`
      <img loading="lazy" src="${ch.logo}">
      <div class="channel-name">${ch.name}</div>
      <div class="fav" onclick="event.stopPropagation();toggleFavorite('${ch.id}')">
        ${favorites.includes(ch.id)?"‚òÖ":"‚òÜ"}
      </div>`;
    div.onclick=()=>play(start+i);
    frag.appendChild(div);
  });
  list.appendChild(frag);
  page++;
}

window.addEventListener("scroll",()=>{
  if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200){
    renderNext();
  }
});

function play(index){
  const v=document.getElementById("player"), url=visibleChannels[index].url;
  if(Hls.isSupported()){
    const hls=new Hls(); hls.loadSource(url); hls.attachMedia(v);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play());
  }else{v.src=url;v.play();}
}

function toggleFavorite(id){
  favorites=favorites.includes(id)?favorites.filter(f=>f!==id):[...favorites,id];
  localStorage.setItem("favorites_vt",JSON.stringify(favorites));
  resetRender();
}

loadList();
</script>

</body>
</html>