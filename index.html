<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TV en Vivo VT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<!-- Adsterra Banner -->
<script>
atOptions = {
  'key' : '9e84da7cb4c4852358b069502cb5718d',
  'format' : 'iframe',
  'height' : 60,
  'width' : 468,
  'params' : {}
};
</script>
<script src="https://www.highperformanceformat.com/9e84da7cb4c4852358b069502cb5718d/invoke.js"></script>

<style>
body { margin:0; background:#000; color:white; font-family:Arial; }
header { background:#111; padding:10px; text-align:center; font-size:20px; position:sticky; top:0; z-index:1000; }
#playerBox { position:sticky; top:50px; background:black; z-index:999; }
#player { width:100%; height:260px; }
#controls { display:flex; justify-content:space-around; padding:8px; background:#1a1a1a; }
button { background:#e50914; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
#search { width:95%; margin:10px auto; display:block; padding:10px; border-radius:20px; border:none; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px; padding:10px; }
.card { background:#1a1a1a; padding:10px; border-radius:8px; cursor:pointer; }
.card.active { background:#333; }
#category { width:95%; margin:10px auto; padding:8px; border-radius:10px; }
#ad { text-align:center; margin:10px; }
</style>
</head>

<body>

<header>üì∫ TV en Vivo VT</header>

<div id="playerBox">
  <video id="player" controls autoplay></video>
  <div id="controls">
    <button onclick="castScreen()">üì° Transmitir</button>
    <button onclick="showFavorites()">‚≠ê Favoritos</button>
  </div>
</div>

<div id="ad"></div>

<select id="category" onchange="filterCategory()">
  <option value="ALL">üåç Todas las categor√≠as</option>
</select>

<input type="text" id="search" placeholder="üîç Buscar canal...">

<div class="grid" id="list"></div>

<script>
const IPTV_URL = "https://iptv-org.github.io/iptv/index.nsfw.m3u";
let allChannels = [];
let filtered = [];
let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
let currentIndex = 0;

// Cargar lista
fetch(IPTV_URL)
.then(r=>r.text())
.then(data=>{
  const lines = data.split("\n");
  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      const name = lines[i].split(",")[1];
      const groupMatch = lines[i].match(/group-title="(.*?)"/);
      const group = groupMatch ? groupMatch[1] : "Otros";
      const url = lines[i+1];
      allChannels.push({name, group, url});
    }
  }
  filtered = allChannels;
  buildCategories();
  render();
  play(0);
});

function buildCategories(){
  const groups = [...new Set(allChannels.map(c=>c.group))];
  const sel = document.getElementById("category");
  groups.forEach(g=>{
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    sel.appendChild(opt);
  });
}

function filterCategory(){
  const cat = document.getElementById("category").value;
  filtered = cat==="ALL" ? allChannels : allChannels.filter(c=>c.group===cat);
  render();
}

function render(){
  const grid = document.getElementById("list");
  grid.innerHTML="";
  filtered.forEach((c,i)=>{
    const d = document.createElement("div");
    d.className = "card" + (i===currentIndex ? " active":"");
    d.innerHTML = c.name + `<br><small onclick="event.stopPropagation();toggleFav('${c.name}')">
      ${favorites.includes(c.name) ? "‚òÖ Quitar" : "‚òÜ Favorito"}</small>`;
    d.onclick = ()=>play(i);
    grid.appendChild(d);
  });
}

function play(i){
  currentIndex = i;
  const video = document.getElementById("player");
  const url = filtered[i].url;

  if(Hls.isSupported()){
    const hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, ()=>video.play());
  } else {
    video.src = url;
    video.play();
  }
  render();
}

function toggleFav(name){
  if(favorites.includes(name)){
    favorites = favorites.filter(f=>f!==name);
  } else {
    favorites.push(name);
  }
  localStorage.setItem("favorites", JSON.stringify(favorites));
  render();
}

function showFavorites(){
  filtered = allChannels.filter(c=>favorites.includes(c.name));
  render();
}

document.getElementById("search").addEventListener("input", function(){
  const t = this.value.toLowerCase();
  filtered = allChannels.filter(c=>c.name.toLowerCase().includes(t));
  render();
});

function castScreen(){
  alert("Para transmitir a tu TV, usa 'Transmitir Pantalla' desde el men√∫ de Android.");
}
</script>

</body>
</html>