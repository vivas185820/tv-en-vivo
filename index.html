<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV en Vivo VT</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial}
#header{position:fixed;top:0;left:0;right:0;height:44px;background:#111;display:flex;align-items:center;justify-content:center}
#playerWrapper{position:fixed;top:44px;left:0;right:0;height:180px;background:#000}
#player{width:100%;height:100%;object-fit:contain}
#content{margin-top:235px;padding:10px}
.section{margin-bottom:8px}
select,input,button{width:100%;background:#1c1c1c;color:white;border:none;padding:6px;border-radius:5px;margin-top:4px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.channel{background:#1a1a1a;border-radius:6px;padding:6px;text-align:center}
.channel img{width:100%;height:60px;object-fit:contain}
.name{font-size:12px}
.fav{font-size:18px}
</style>
</head>

<body>

<div id="header">üì∫ TV en Vivo VT</div>

<div id="playerWrapper">
  <video id="player" controls playsinline></video>
</div>

<div id="content">

<div class="section">
<button onclick="showFavorites()">‚≠ê Ver favoritos</button>
</div>

<div class="section">
<button onclick="toggleSettings()">‚öô Ajustes IPTV</button>
<div id="settings" style="display:none">
<input id="iptvUrl">
<button onclick="saveIPTV()">Guardar</button>
</div>
</div>

<div class="section">
<select id="category"></select>
</div>

<div class="section">
<input id="search" placeholder="Buscar canal...">
</div>

<div class="grid" id="list"></div>

</div>

<script>
let IPTV_URL = localStorage.getItem("iptv_url") || https://raw.githubusercontent.com/iptv-org/iptv/master/languages/spa.m3u;
let all=[], view=[], favs=JSON.parse(localStorage.getItem("favs")||"[]");

function toggleSettings(){
  document.getElementById("settings").style.display = "block";
  document.getElementById("iptvUrl").value = IPTV_URL;
}

function saveIPTV(){
  IPTV_URL = document.getElementById("iptvUrl").value;
  localStorage.setItem("iptv_url", IPTV_URL);
  location.reload();
}

fetch(IPTV_URL).then(r=>r.text()).then(text=>{
  const lines=text.split("\n");
  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      const name=lines[i].split(",")[1];
      const logo=(lines[i].match(/tvg-logo="(.*?)"/)||[])[1]||"https://via.placeholder.com/150x80?text=TV";
      const group=(lines[i].match(/group-title="(.*?)"/)||[])[1]||"Otros";
      const url=lines[i+1];
      all.push({name,logo,group,url,id:btoa(name+url)});
    }
  }
  view=[...all];
  loadCategories();
  render();
  play(0);
});

function loadCategories(){
  const sel=document.getElementById("category");
  const cats=["Todos",...new Set(all.map(c=>c.group))];
  cats.forEach(c=>{
    const o=document.createElement("option");
    o.value=c; o.textContent=c;
    sel.appendChild(o);
  });
  sel.onchange=()=>filter();
}

document.getElementById("search").oninput=()=>filter();

function filter(){
  const t=document.getElementById("search").value.toLowerCase();
  const cat=document.getElementById("category").value;

  view = all.filter(c=>{
    return (cat==="Todos"||c.group===cat) && c.name.toLowerCase().includes(t);
  });
  render();
}

function showFavorites(){
  view = all.filter(c=>favs.includes(c.id));
  render();
}

function render(){
  const box=document.getElementById("list");
  box.innerHTML="";
  view.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="channel";
    d.innerHTML=`
      <img src="${c.logo}">
      <div class="name">${c.name}</div>
      <div class="fav" onclick="event.stopPropagation();toggleFav('${c.id}')">${favs.includes(c.id)?"‚òÖ":"‚òÜ"}</div>
    `;
    d.onclick=()=>play(i);
    box.appendChild(d);
  });
}

function play(i){
  const v=document.getElementById("player");
  const url=view[i].url;
  if(Hls.isSupported()){
    const hls=new Hls();
    hls.loadSource(url);
    hls.attachMedia(v);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play());
  }else{
    v.src=url; v.play();
  }
}

function toggleFav(id){
  if(favs.includes(id))favs=favs.filter(f=>f!==id);
  else favs.push(id);
  localStorage.setItem("favs",JSON.stringify(favs));
  render();
}
</script>

</body>
</html>