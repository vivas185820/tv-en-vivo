<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TV en Vivo VT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body { margin:0; background:#0b0b0b; color:#eee; font-family:Arial; }
#top {
  position:fixed; top:0; left:0; right:0;
  background:#111; z-index:1000; padding:8px;
  text-align:center; font-size:18px;
}
#playerBox {
  position:fixed; top:40px; left:0; right:0;
  height:180px; background:black; z-index:999;
  border-bottom:2px solid #1a1a1a;
}
#player {
  width:100%; height:180px; object-fit:contain; background:#000;
}
#playerControls {
  position:absolute; bottom:5px; right:5px;
}
#playerControls button {
  background:#e50914; border:none; color:white;
  padding:4px 8px; border-radius:4px; margin-left:4px;
}
#content { margin-top:230px; padding:10px; }
#bar { display:flex; gap:6px; margin-bottom:10px; }
#bar select, #bar input, #bar button {
  background:#1a1a1a; color:white; border:none;
  padding:6px; border-radius:6px;
}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(110px,1fr));
  gap:10px;
}
.card {
  background:#1a1a1a;
  border-radius:6px;
  padding:6px;
  text-align:center;
  cursor:pointer;
}
.card img { width:100%; height:70px; object-fit:contain; }
.card small { font-size:11px; display:block; }
.card.active { background:#333; }

#settings {
  position:fixed; inset:0; background:rgba(0,0,0,.9);
  display:none; z-index:2000; align-items:center; justify-content:center;
}
#settingsBox {
  background:#111; padding:20px; border-radius:8px;
  width:90%; max-width:400px;
}
</style>
</head>

<body>

<div id="top">üì∫ TV en Vivo VT</div>

<div id="playerBox">
  <video id="player" controls autoplay></video>
  <div id="playerControls">
    <button onclick="goFull()">‚õ∂</button>
    <button onclick="cast()">üì°</button>
  </div>
</div>

<div id="content">
  <div id="bar">
    <select id="category" onchange="filterCategory()"></select>
    <input type="text" placeholder="Buscar..." oninput="search(this.value)">
    <button onclick="showFavorites()">‚≠ê</button>
    <button onclick="openSettings()">‚öô</button>
  </div>

  <div class="grid" id="list"></div>
</div>

<div id="settings">
  <div id="settingsBox">
    <h3>Lista IPTV</h3>
    <input id="iptvUrl" style="width:100%;padding:8px">
    <br><br>
    <button onclick="saveSettings()">Guardar</button>
    <button onclick="closeSettings()">Cerrar</button>
  </div>
</div>

<script>
let IPTV_URL = localStorage.getItem("iptv_url") || "https://iptv-org.github.io/iptv/languages/spa.m3u";
let all=[], filtered=[], favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
let current=0;

document.getElementById("iptvUrl").value = IPTV_URL;
loadIPTV();

function loadIPTV(){
  fetch(IPTV_URL).then(r=>r.text()).then(data=>{
    const lines=data.split("\n");
    all=[];
    for(let i=0;i<lines.length;i++){
      if(lines[i].startsWith("#EXTINF")){
        const name=lines[i].split(",")[1];
        const group=(lines[i].match(/group-title="(.*?)"/)||[])[1]||"Otros";
        const logo=(lines[i].match(/tvg-logo="(.*?)"/)||[])[1]||"https://upload.wikimedia.org/wikipedia/commons/7/75/TV_icon.png";
        const url=lines[i+1];
        all.push({name,group,logo,url});
      }
    }
    filtered=all;
    buildCategories();
    render();
    play(0);
  });
}

function buildCategories(){
  const sel=document.getElementById("category");
  sel.innerHTML="";
  ["Todos",...new Set(all.map(c=>c.group))].forEach(g=>{
    const o=document.createElement("option");
    o.value=g; o.textContent=g;
    sel.appendChild(o);
  });
}

function filterCategory(){
  const v=document.getElementById("category").value;
  filtered = v==="Todos" ? all : all.filter(c=>c.group===v);
  render();
}

function search(t){
  t=t.toLowerCase();
  filtered = all.filter(c=>c.name.toLowerCase().includes(t));
  render();
}

function render(){
  const grid=document.getElementById("list");
  grid.innerHTML="";
  filtered.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(i===current?" active":"");
    d.innerHTML = `
      <img src="${c.logo}">
      <small>${c.name}</small>
      <small onclick="event.stopPropagation();toggleFav('${c.name}')">
        ${favorites.includes(c.name)?"‚òÖ":"‚òÜ"}
      </small>`;
    d.onclick=()=>play(i);
    grid.appendChild(d);
  });
}

function play(i){
  current=i;
  const v=document.getElementById("player");
  const url=filtered[i].url;
  if(Hls.isSupported()){
    const hls=new Hls();
    hls.loadSource(url);
    hls.attachMedia(v);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>v.play());
  } else {
    v.src=url; v.play();
  }
  render();
}

function toggleFav(name){
  if(favorites.includes(name)) favorites=favorites.filter(f=>f!==name);
  else favorites.push(name);
  localStorage.setItem("favorites", JSON.stringify(favorites));
  render();
}

function showFavorites(){
  filtered = all.filter(c=>favorites.includes(c.name));
  render();
}

function openSettings(){ document.getElementById("settings").style.display="flex"; }
function closeSettings(){ document.getElementById("settings").style.display="none"; }
function saveSettings(){
  const url=document.getElementById("iptvUrl").value.trim();
  if(url){
    localStorage.setItem("iptv_url", url);
    IPTV_URL=url;
    closeSettings();
    loadIPTV();
  }
}

function goFull(){
  const v=document.getElementById("player");
  if(v.requestFullscreen) v.requestFullscreen();
}

function cast(){
  alert("Usa 'Transmitir pantalla' desde el men√∫ de Android para enviar a tu TV.");
}
</script>

</body>
</html>